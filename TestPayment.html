<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸ (ë¡œê·¸ì¸ ê¸°ëŠ¥)</title>
    <!-- PortOne V2 Browser SDK -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { background: #f8f9fa; padding: 30px; border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .result { 
            margin-top: 25px; 
            padding: 20px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .step { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 6px; 
            border-left: 4px solid #007bff;
        }
        .step h3 { margin-top: 0; color: #007bff; }
        .config-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        /* QR ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .qr-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .qr-modal-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qr-modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .qr-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .qr-close:hover {
            opacity: 0.7;
        }
        
        .qr-modal-body {
            padding: 30px;
            text-align: center;
        }
        
        .qr-modal-body h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .qr-modal-body p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .qr-container {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .qr-container img {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .qr-container img:hover {
            transform: scale(1.05);
        }
        
        .order-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .order-info p {
            margin: 8px 0;
            font-size: 16px;
            color: #495057;
        }
        
        .order-info strong {
            color: #212529;
        }
        
        .qr-actions {
            margin-top: 20px;
        }
        
        .qr-instruction {
            font-size: 14px;
            color: #6c757d;
            margin: 8px 0;
            font-style: italic;
        }
        
        .qr-tip {
            font-size: 16px;
            color: #28a745;
            font-weight: 600;
            margin: 12px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸ (ë¡œê·¸ì¸ ê¸°ëŠ¥)</h1>
        
        <div class="config-box">
            <h3>âš™ï¸ V2 ì„¤ì • ê°€ì´ë“œ</h3>
            <p><strong>1.</strong> <a href="https://console.portone.io" target="_blank">PortOne ì½˜ì†”</a>ì—ì„œ V2 ê³„ì • ìƒì„±</p>
            <p><strong>2.</strong> Store IDì™€ API Secret ë°œê¸‰</p>
            <p><strong>3.</strong> ì•„ë˜ ì„¤ì • íŒŒì¼ì— ì‹¤ì œ ê°’ ì…ë ¥:</p>
            <pre>application.yml:
portone:
  v2:
    store-id: "ì‹¤ì œ_ìŠ¤í† ì–´_ID"
    api-secret: "ì‹¤ì œ_API_ì‹œí¬ë¦¿"</pre>
        </div>

        <div class="step">
            <h3>ğŸ“ íšŒì›ê°€ì…</h3>
            <div class="form-group">
                <label>ì•„ì´ë””:</label>
                <input type="text" id="registerUsername" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="registerPassword" placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
            </div>
            <div class="form-group">
                <label>ë‹‰ë„¤ì„:</label>
                <input type="text" id="registerNickname" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„">
            </div>
            <button class="btn" onclick="handleRegister()" style="background: #17a2b8;">ğŸ“ íšŒì›ê°€ì…</button>
        </div>

        <div class="step">
            <h3>ğŸ” ì‚¬ìš©ì ì¸ì¦</h3>
            <div class="form-group">
                <label>ì•„ì´ë””:</label>
                <input type="text" id="loginUsername" value="test_user" placeholder="test_user, test_admin ë“±">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="loginPassword" value="1234">
            </div>
            <button class="btn" onclick="handleLogin()" style="background: #28a745;">ğŸ”‘ ë¡œê·¸ì¸ (í† í° ë°œê¸‰)</button>
            <p id="loginStatus" style="margin-top: 10px; font-weight: bold;"></p>
        </div>

        <div class="step">
            <h3>ğŸ›ï¸ 1ë‹¨ê³„: ì£¼ë¬¸ ì •ë³´ ì…ë ¥</h3>
            <div class="form-group">
                <label>ì‚¬ìš©ì ID (ë¡œê·¸ì¸ ì‹œ ìë™ ì„¤ì •):</label>
                <input type="number" id="userId" readonly>
            </div>
            <div class="form-group">
                <label>ë§¤ì¥ ID:</label>
                <input type="number" id="storeId" value="1">
            </div>
            <div class="form-group">
                <label>ìˆ˜ë ¹ì¸ ì´ë¦„:</label>
                <input type="text" id="recipientName" value="í™ê¸¸ë™">
            </div>
            <div class="form-group">
                <label>ê²°ì œ ë°©ë²•:</label>
                <select id="paymentMethod">
                    <option value="CARD">ì‹ ìš©ì¹´ë“œ</option>
                    <option value="KAKAOPAY">ì¹´ì¹´ì˜¤í˜ì´</option>
                    <option value="TOSSPAY">í† ìŠ¤í˜ì´</option>
                </select>
            </div>
            <div class="form-group">
                <label>ìƒí’ˆëª…:</label>
                <input type="text" id="itemName" value="í…ŒìŠ¤íŠ¸ ìƒí’ˆ">
            </div>
            <div class="form-group">
                <label>ìƒí’ˆ ID:</label>
                <input type="number" id="productId" value="1">
            </div>
            <div class="form-group">
                <label>ìˆ˜ëŸ‰:</label>
                <input type="number" id="quantity" value="2" min="1">
            </div>
            <div class="form-group">
                <label>ë‹¨ê°€:</label>
                <input type="number" id="itemPrice" value="500" min="1">
            </div>
            <button class="btn" onclick="startPaymentFlow()">ğŸš€ V2 ê²°ì œ í”Œë¡œìš° ì‹œì‘</button>
        </div>
        
        <div class="step">
            <h3>ğŸ“± 2ë‹¨ê³„: V2 ê²°ì œ ì§„í–‰</h3>
            <button class="btn" id="paymentBtn" onclick="proceedPayment()" disabled>
                ğŸ’³ PortOne V2 ê²°ì œ ì§„í–‰
            </button>
        </div>

        <div class="step">
            <h3>ğŸ§ª 3ë‹¨ê³„: API í…ŒìŠ¤íŠ¸ ë„êµ¬ë“¤</h3>
            
            <div class="form-group">
                <label>ì£¼ë¬¸ IDë¡œ ì£¼ë¬¸ ì¡°íšŒ:</label>
                <input type="text" id="qrToken" placeholder="ì£¼ë¬¸ ID ì…ë ¥">
                <button class="btn" onclick="lookupOrderByQr()">ğŸ” ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ</button>
            </div>
            
            <div class="form-group">
                <label>ì£¼ë¬¸ IDë¡œ ìˆ˜ë ¹ ë“±ë¡:</label>
                <input type="text" id="receiveOrderId" placeholder="ì£¼ë¬¸ ID ì…ë ¥">
                <button class="btn" onclick="receiveOrder()">ğŸ“¦ ìˆ˜ë ¹ ë“±ë¡</button>
            </div>
            
            <div class="form-group">
                <label>ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ (ìˆœì°¨ì  ë³€ê²½):</label>
                <input type="text" id="updateOrderId" placeholder="ì£¼ë¬¸ ID ì…ë ¥">
                <button class="btn" onclick="checkOrderStatusForUpdate()">ğŸ” í˜„ì¬ ìƒíƒœ í™•ì¸</button>
                <div id="currentStatusInfo" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <strong>í˜„ì¬ ìƒíƒœ:</strong> <span id="currentStatus"></span><br>
                    <strong>ë‹¤ìŒ ê°€ëŠ¥í•œ ìƒíƒœ:</strong>
                    <select id="newOrderStatus" disabled>
                        <option value="">ë¨¼ì € í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</option>
                    </select>
                </div>
                <button class="btn" onclick="updateOrderStatus()" id="updateStatusBtn" disabled>âš™ï¸ ìƒíƒœ ë³€ê²½</button>
            </div>
            
            <div class="form-group">
                <label>ì‚¬ìš©ì ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ:</label>
                <button class="btn" onclick="getUserOrders()">ğŸ“‹ ë‚´ ì£¼ë¬¸ ëª©ë¡ ë³´ê¸°</button>
            </div>
            
            <div class="form-group">
                <label>ê²°ì œ ìƒíƒœ ì¡°íšŒ:</label>
                <input type="text" id="paymentStatusId" placeholder="ê²°ì œ ID ì…ë ¥">
                <button class="btn" onclick="getPaymentStatus()">ğŸ’³ ê²°ì œ ìƒíƒœ í™•ì¸</button>
            </div>
        </div>
        
        <div class="result" id="result"></div>
        
        <!-- QR ì½”ë“œ ëª¨ë‹¬ -->
        <div id="qrModal" class="qr-modal" style="display: none;">
            <div class="qr-modal-content">
                <div class="qr-modal-header">
                    <h2>ğŸ‰ ê²°ì œ ì™„ë£Œ!</h2>
                    <span class="qr-close" onclick="closeQrModal()">&times;</span>
                </div>
                <div class="qr-modal-body">
                    <h3>ğŸ“± ìˆ˜ë ¹ìš© QR ì½”ë“œ</h3>
                    <p>ë§¤ì¥ì—ì„œ ì´ QR ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”</p>
                    <div class="qr-container">
                        <img id="qrCodeImage" src="" alt="QR Code" />
                    </div>
                    <div class="order-info">
                        <p><strong>ì£¼ë¬¸ ID:</strong> <span id="modalOrderId"></span></p>
                        <p><strong>ìˆ˜ë ¹ì¸:</strong> <span id="modalRecipient"></span></p>
                        <p><strong>ê²°ì œ ê¸ˆì•¡:</strong> <span id="modalAmount"></span>ì›</p>
                    </div>
                    <div class="qr-actions">
                        <p class="qr-instruction">ğŸ’¡ í™”ë©´ì„ ìº¡ì²˜í•˜ê±°ë‚˜ ìš°í´ë¦­ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ì„¸ìš”</p>
                        <p class="qr-tip">ğŸª ë§¤ì¥ì—ì„œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì£¼ë¬¸ì„ ìˆ˜ë ¹í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const BASE_URL = 'https://coubee-api.murkui.com';
        let currentOrder = null;
        let portoneConfig = null;
        let currentOrderItems = null; // í˜„ì¬ ì£¼ë¬¸ì˜ ìƒí’ˆ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        let currentPaymentId = null; // í˜„ì¬ ê²°ì œ IDë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

        // --- Auth functions ---
        function base64ToUtf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        function updateLoginStatus() {
            const token = sessionStorage.getItem('accessToken');
            const statusEl = document.getElementById('loginStatus');
            if (token) {
                try {
                    const payloadBase64 = token.split('.')[1];
                    const payload = JSON.parse(base64ToUtf8(payloadBase64));
                    const exp = payload.exp * 1000;
                    
                    // JWT payload ë””ë²„ê¹…
                    console.log('ğŸ” JWT Payload:', payload);
                    
                    statusEl.textContent = `âœ… ë¡œê·¸ì¸ë¨: ${payload.username} (ë§Œë£Œ: ${new Date(exp).toLocaleString()})`;
                    statusEl.style.color = '#28a745';
                    
                    // userId í•„ë“œ í™•ì¸ ë° ì„¤ì •
                    const userId = payload.userId || payload.sub || payload.id;
                    document.getElementById('userId').value = userId;
                    console.log('ğŸ‘¤ ì‚¬ìš©ì ID ì„¤ì •:', userId);
                } catch (e) {
                    console.error('âŒ JWT í† í° íŒŒì‹± ì˜¤ë¥˜:', e);
                    console.log('ğŸ” í† í° ê°’:', token);
                    statusEl.textContent = 'âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                    statusEl.style.color = '#ffc107';
                    sessionStorage.removeItem('accessToken');
                }
            } else {
                statusEl.textContent = 'âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                statusEl.style.color = '#dc3545';
                document.getElementById('userId').value = '';
            }
        }

        async function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const nickName = document.getElementById('registerNickname').value;

            try {
                log(`ğŸ“ íšŒì›ê°€ì…ì„ ì‹œë„í•©ë‹ˆë‹¤: ${username}`);
                const response = await fetch(`${BASE_URL}/api/user/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nickName, role: 'USER' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`íšŒì›ê°€ì… ì‹¤íŒ¨ (${response.status}): ${errorData.message}`);
                }

                log('âœ… íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                log(`âŒ íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, true);
            }
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                log(`ğŸ”‘ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤: ${username}`);
                const response = await fetch(`${BASE_URL}/api/user/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨ (${response.status}): ${errorData.message}`);
                }

                const result = await response.json();
                const accessToken = result.data.accessRefreshToken.access.token;
                
                console.log('ğŸ” ë¡œê·¸ì¸ ì‘ë‹µ:', result);
                console.log('ğŸ« ì¶”ì¶œëœ í† í°:', accessToken);

                sessionStorage.setItem('accessToken', accessToken);
                
                log('âœ… ë¡œê·¸ì¸ ì„±ê³µ! Access Tokenì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateLoginStatus();

            } catch (error) {
                log(`âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, true);
                sessionStorage.removeItem('accessToken');
                updateLoginStatus();
            }
        }
        
        function getAuthHeaders() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                log('âŒ ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.', true);
                throw new Error('ì¸ì¦ í† í° ì—†ìŒ');
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // --- Common and Payment Flow ---
        function log(message, isError = false) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}
`;
            
            resultDiv.textContent += logEntry;
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            console.log(message);
        }

        function getPortOnePayMethod(paymentMethod) {
            const payMethodMap = { 'CARD': 'CARD', 'KAKAOPAY': 'EASY_PAY', 'TOSSPAY': 'EASY_PAY' };
            return payMethodMap[paymentMethod] || paymentMethod;
        }

        async function fetchPaymentConfig() {
            log('âš™ï¸ ë°±ì—”ë“œì—ì„œ ê²°ì œ ì„¤ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤...');
            try {
                const response = await fetch(`${BASE_URL}/api/order/payment/config`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 403) {
                    log('âŒ ê²Œì´íŠ¸ì›¨ì´ ì¸ì¦ ì‹¤íŒ¨ (403 Forbidden). JWT í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', true);
                    log('ğŸ’¡ í•´ê²° ë°©ë²•: ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì—¬ ìƒˆë¡œìš´ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.', true);
                    throw new Error(`ì¸ì¦ ì‹¤íŒ¨ (${response.status})`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ ì„¤ì • ì •ë³´ ë¡œë”© ì‹¤íŒ¨ (${response.status}): ${errorText}`, true);
                    throw new Error(`ì„¤ì • ì •ë³´ ë¡œë”© ì‹¤íŒ¨ (${response.status})`);
                }

                const configResponse = await response.json();
                portoneConfig = configResponse.data;
                log(`âœ… ê²°ì œ ì„¤ì • ë¡œë“œ ì™„ë£Œ! Store ID: ${portoneConfig.storeId}`);
            } catch (error) {
                log(`âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, true);
                throw error;
            }
        }
        
        async function startPaymentFlow() {
            try {
                document.getElementById('result').textContent = '';
                log('ğŸš€ PortOne V2 ê²°ì œ í”Œë¡œìš°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                await fetchPaymentConfig();
                await createOrder();
                await preparePayment();

                if (currentOrder) {
                    document.getElementById('paymentBtn').disabled = false;
                    log('âœ… ì£¼ë¬¸ ë° ê²°ì œ ì¤€ë¹„ ì™„ë£Œ! ì´ì œ "PortOne V2 ê²°ì œ ì§„í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                }
            } catch (error) {
                // ì—ëŸ¬ëŠ” ê° í•¨ìˆ˜ì—ì„œ ì´ë¯¸ ë¡œê·¸ë¡œ ë‚¨ê¹€
            }
        }
        
        async function createOrder() {
            const itemName = document.getElementById('itemName').value;
            const productId = parseInt(document.getElementById('productId').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const itemPrice = parseInt(document.getElementById('itemPrice').value);

            currentOrderItems = [{
                productId: productId,
                name: itemName,
                quantity: quantity,
                price: itemPrice
            }];

            const orderData = {
                storeId: parseInt(document.getElementById('storeId').value),
                recipientName: document.getElementById('recipientName').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                totalAmount: quantity * itemPrice, // ì´ì•¡ ê³„ì‚°
                items: currentOrderItems
            };
            
            log('ğŸ“ ì£¼ë¬¸ ìƒì„± ì¤‘...');
            
            try {
                const headers = getAuthHeaders();
                const response = await fetch(`${BASE_URL}/api/order/orders`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(orderData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨ (${response.status}): ${errorText}`);
                }
                
                currentOrder = await response.json();
                log(`âœ… ì£¼ë¬¸ ìƒì„± ì„±ê³µ! ì£¼ë¬¸ ID: ${currentOrder.data.orderId}, ê¸ˆì•¡: ${currentOrder.data.amount}ì›`);
            } catch (error) {
                log(`âŒ ì£¼ë¬¸ ìƒì„± ì˜¤ë¥˜: ${error.message}`, true);
                throw error;
            }
        }

        async function preparePayment() {
            if (!currentOrder) {
                log('âŒ ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.', true);
                throw new Error('ì£¼ë¬¸ ì •ë³´ ì—†ìŒ');
            }

            log('ğŸ’³ ê²°ì œ ì¤€ë¹„ ì¤‘...');

            try {
                const prepareData = {
                    storeId: parseInt(document.getElementById('storeId').value),
                    items: currentOrderItems
                };

                const headers = getAuthHeaders();
                const response = await fetch(`${BASE_URL}/api/order/payment/orders/${currentOrder.data.orderId}/prepare`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(prepareData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨ (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                log(`âœ… ê²°ì œ ì¤€ë¹„ ì„±ê³µ! Merchant UID: ${result.data.merchantUid}`);

            } catch (error) {
                log(`âŒ ê²°ì œ ì¤€ë¹„ ì˜¤ë¥˜: ${error.message}`, true);
                throw error;
            }
        }

        async function proceedPayment() {
            if (!currentOrder || !portoneConfig) {
                log('âŒ ì£¼ë¬¸ ë˜ëŠ” ê²°ì œ ì„¤ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.', true);
                return;
            }
            
            try {
                log('ğŸ¯ PortOne V2 ê²°ì œì°½ì„ í˜¸ì¶œí•©ë‹ˆë‹¤...');
                const selectedPayMethodKey = document.getElementById('paymentMethod').value;
                const channelKey = portoneConfig.channelKeys[selectedPayMethodKey.toLowerCase()];
                const portOnePayMethod = getPortOnePayMethod(selectedPayMethodKey);

                if (!channelKey) {
                    log(`âŒ ì„¤ì • ì˜¤ë¥˜: '${selectedPayMethodKey}'ì— ëŒ€í•œ ì±„ë„ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true);
                    return;
                }

                const paymentData = {
                    storeId: portoneConfig.storeId,
                    channelKey: channelKey,
                    paymentId: currentOrder.data.paymentId,
                    orderName: currentOrder.data.orderName,
                    totalAmount: currentOrder.data.amount,
                    currency: "KRW",
                    payMethod: portOnePayMethod,
                    customer: {
                        fullName: currentOrder.data.buyerName,
                        phoneNumber: "010-1234-5678",
                        email: "test@example.com"
                    },
                    redirectUrl: `${window.location.origin}/payment-complete?orderId=${currentOrder.data.orderId}`,
                    notificationUrls: [`${BASE_URL}/api/order/webhook/portone`]
                };

                const response = await window.PortOne.requestPayment(paymentData);
                
                if (response.code != null) {
                    log(`âŒ ê²°ì œ ì‹¤íŒ¨: ${response.message}`, true);
                } else {
                    log(`ğŸ‰ ê²°ì œ ì„±ê³µ! ê²°ì œ ID: ${response.paymentId}`);
                    currentPaymentId = response.paymentId; // ê²°ì œ ID ì €ì¥
                    await showPickupQrCode(currentOrder.data.orderId);
                }
            } catch (error) {
                log(`âŒ ê²°ì œ ê³¼ì •ì—ì„œ ì˜¤ë¥˜: ${error.message}`, true);
            }
        }

        // --- QR Modal and API Test Tools ---
        async function showPickupQrCode(orderId) {
            if (!currentOrder) {
                log('âŒ QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨: ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            try {
                log('ğŸ“± ìˆ˜ë ¹ QR ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤...');
                
                const qrImageUrl = `${BASE_URL}/api/order/qr/orders/${orderId}?size=200`;
                
                // ì¸ì¦ í—¤ë”ì™€ í•¨ê»˜ QR ì½”ë“œ ì´ë¯¸ì§€ ìš”ì²­
                const headers = getAuthHeaders();
                const response = await fetch(qrImageUrl, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`QR ì½”ë“œ ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
                }
                
                // ì´ë¯¸ì§€ blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                // ëª¨ë‹¬ì— ì •ë³´ ì„¤ì • (ì „ì—­ ë³€ìˆ˜ currentOrder ì‚¬ìš©)
                const qrCodeImage = document.getElementById('qrCodeImage');
                qrCodeImage.src = imageUrl;
                
                // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ ì´ì „ URL í•´ì œ
                qrCodeImage.onload = () => {
                    if (qrCodeImage.dataset.prevUrl) {
                        URL.revokeObjectURL(qrCodeImage.dataset.prevUrl);
                    }
                    qrCodeImage.dataset.prevUrl = imageUrl;
                };
                document.getElementById('modalOrderId').textContent = orderId;
                document.getElementById('modalRecipient').textContent = currentOrder.data.buyerName;
                document.getElementById('modalAmount').textContent = currentOrder.data.amount.toLocaleString();
                
                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('qrModal').style.display = 'block';
                
                log('âœ… ìˆ˜ë ¹ QR ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                log(`âŒ QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        function closeQrModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('qrModal');
            if (event.target === modal) {
                closeQrModal();
            }
        }

        async function lookupOrderByQr() {
            const orderId = document.getElementById('qrToken').value.trim();
            if (!orderId) {
                log('âŒ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }
            try {
                log(`ğŸ” ì£¼ë¬¸ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤: ${orderId}`);
                const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }
                const result = await response.json();
                log('âœ… ì£¼ë¬¸ ì¡°íšŒ ì„±ê³µ!');
                log(JSON.stringify(result.data, null, 2));
                document.getElementById('receiveOrderId').value = orderId;
            } catch (error) {
                log(`âŒ ì£¼ë¬¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        async function receiveOrder() {
            const orderId = document.getElementById('receiveOrderId').value.trim();
            if (!orderId) {
                log('âŒ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }
            try {
                log(`ğŸ“¦ ì£¼ë¬¸ ìˆ˜ë ¹ì„ ë“±ë¡í•©ë‹ˆë‹¤: ${orderId}`);
                const headers = getAuthHeaders();
                headers['Content-Type'] = 'application/json';
                
                const requestData = {};
                log(`ğŸ“ ìˆ˜ë ¹ ë“±ë¡ ìš”ì²­ ë°ì´í„°: ${JSON.stringify(requestData)}`);
                log(`ğŸ“ ìš”ì²­ í—¤ë”: ${JSON.stringify(headers)}`);
                
                const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}/receive`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                });
                if (!response.ok) {
                    throw new Error(`ìˆ˜ë ¹ ë“±ë¡ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }
                const result = await response.json();
                log('âœ… ìˆ˜ë ¹ ë“±ë¡ ì„±ê³µ!');
                log(JSON.stringify(result.data, null, 2));
            } catch (error) {
                log(`âŒ ìˆ˜ë ¹ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        async function getUserOrders() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                log('âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', true);
                return;
            }
            try {
                log(`ğŸ“‹ ì‚¬ìš©ì ${userId}ì˜ ì£¼ë¬¸ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤...`);
                const response = await fetch(`${BASE_URL}/api/order/users/${userId}/orders?page=0&size=10`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }
                const result = await response.json();
                log('âœ… ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ ì„±ê³µ!');
                log(JSON.stringify(result.data, null, 2));
            } catch (error) {
                log(`âŒ ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        async function getPaymentStatus() {
            let paymentId = document.getElementById('paymentStatusId').value.trim();
            
            // ì…ë ¥ëœ ê²°ì œ IDê°€ ì—†ìœ¼ë©´ ì €ì¥ëœ ê²°ì œ ID ì‚¬ìš©
            if (!paymentId && currentPaymentId) {
                paymentId = currentPaymentId;
                document.getElementById('paymentStatusId').value = paymentId;
                log(`ğŸ’¾ ì €ì¥ëœ ê²°ì œ IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: ${paymentId}`);
            }
            
            if (!paymentId) {
                log('âŒ ê²°ì œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }
            try {
                log(`ğŸ’³ ê²°ì œ ìƒíƒœë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤: ${paymentId}`);
                const response = await fetch(`${BASE_URL}/api/order/payment/${paymentId}/status`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }
                const result = await response.json();
                log('âœ… ê²°ì œ ìƒíƒœ ì¡°íšŒ ì„±ê³µ!');
                log(JSON.stringify(result.data, null, 2));
            } catch (error) {
                log(`âŒ ê²°ì œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        async function updateOrderStatus() {
            const orderId = document.getElementById('updateOrderId').value.trim();
            const newStatus = document.getElementById('newOrderStatus').value;
            if (!orderId) {
                log('âŒ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }
            try {
                log(`âš™ï¸ ì£¼ë¬¸ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤: ${orderId} â†’ ${newStatus}`);
                const headers = getAuthHeaders();
                headers['Content-Type'] = 'application/json';
                
                const requestData = { status: newStatus };
                log(`ğŸ“ ìƒíƒœ ë³€ê²½ ìš”ì²­ ë°ì´í„°: ${JSON.stringify(requestData)}`);
                log(`ğŸ“ ìš”ì²­ í—¤ë”: ${JSON.stringify(headers)}`);
                
                const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify(requestData)
                });
                if (!response.ok) {
                    throw new Error(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }
                const result = await response.json();
                log('âœ… ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì„±ê³µ!');
                log(JSON.stringify(result.data, null, 2));
            } catch (error) {
                log(`âŒ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        // --- Smart Order Status Management ---
        const ORDER_STATUS_FLOW = {
            'PENDING': ['PAID', 'CANCELLED', 'FAILED'],
            'PAID': ['PREPARING', 'CANCELLED'],
            'PREPARING': ['PREPARED', 'CANCELLED'],
            'PREPARED': ['RECEIVED', 'CANCELLED'],
            'RECEIVED': [], // ìµœì¢… ìƒíƒœ
            'CANCELLED': [], // ìµœì¢… ìƒíƒœ
            'FAILED': ['PENDING'] // ì¬ì‹œë„ ê°€ëŠ¥
        };

        const STATUS_DESCRIPTIONS = {
            'PENDING': 'ê²°ì œ ëŒ€ê¸°',
            'PAID': 'ê²°ì œ ì™„ë£Œ',
            'PREPARING': 'ì¤€ë¹„ ì¤‘',
            'PREPARED': 'ì¤€ë¹„ ì™„ë£Œ',
            'RECEIVED': 'ìˆ˜ë ¹ ì™„ë£Œ',
            'CANCELLED': 'ì·¨ì†Œ',
            'FAILED': 'ì‹¤íŒ¨'
        };

        async function checkOrderStatusForUpdate() {
            const orderId = document.getElementById('updateOrderId').value.trim();
            if (!orderId) {
                log('âŒ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }

            try {
                log(`ğŸ” ì£¼ë¬¸ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤: ${orderId}`);
                const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`ì¡°íšŒ ì‹¤íŒ¨ (${response.status}): ${await response.text()}`);
                }

                const result = await response.json();
                const currentStatus = result.data.status;
                
                log(`âœ… í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ: ${currentStatus} (${STATUS_DESCRIPTIONS[currentStatus]})`);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('currentStatus').textContent = `${currentStatus} (${STATUS_DESCRIPTIONS[currentStatus]})`;
                
                const nextStates = ORDER_STATUS_FLOW[currentStatus] || [];
                const selectElement = document.getElementById('newOrderStatus');
                
                // ì˜µì…˜ ì´ˆê¸°í™”
                selectElement.innerHTML = '';
                
                if (nextStates.length === 0) {
                    selectElement.innerHTML = '<option value="">ë³€ê²½ ê°€ëŠ¥í•œ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤ (ìµœì¢… ìƒíƒœ)</option>';
                    selectElement.disabled = true;
                    document.getElementById('updateStatusBtn').disabled = true;
                } else {
                    selectElement.innerHTML = '<option value="">ë‹¤ìŒ ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    nextStates.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = `${status} (${STATUS_DESCRIPTIONS[status]})`;
                        selectElement.appendChild(option);
                    });
                    selectElement.disabled = false;
                    
                    // ìƒíƒœ ì„ íƒ ì‹œ ë²„íŠ¼ í™œì„±í™”
                    selectElement.onchange = function() {
                        document.getElementById('updateStatusBtn').disabled = !this.value;
                    };
                }
                
                document.getElementById('currentStatusInfo').style.display = 'block';
                
            } catch (error) {
                log(`âŒ ì£¼ë¬¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, true);
                document.getElementById('currentStatusInfo').style.display = 'none';
            }
        }

        async function quickStatusUpdate(targetStatus) {
            const orderId = document.getElementById('updateOrderId').value.trim();
            if (!orderId) {
                log('âŒ ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }

            try {
                // í˜„ì¬ ìƒíƒœ í™•ì¸
                const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`ì£¼ë¬¸ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
                }

                const result = await response.json();
                const currentStatus = result.data.status;
                
                log(`ğŸ¯ ë¹ ë¥¸ ìƒíƒœ ë³€ê²½: ${currentStatus} â†’ ${targetStatus}`);
                
                // ìˆœì°¨ì  ìƒíƒœ ë³€ê²½ ê²½ë¡œ ê³„ì‚°
                const path = getStatusTransitionPath(currentStatus, targetStatus);
                
                if (path.length === 0) {
                    log(`âŒ ${currentStatus}ì—ì„œ ${targetStatus}ë¡œ ì§ì ‘ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true);
                    return;
                }
                
                log(`ğŸ“‹ ìƒíƒœ ë³€ê²½ ê²½ë¡œ: ${path.join(' â†’ ')}`);
                
                // ìˆœì°¨ì ìœ¼ë¡œ ìƒíƒœ ë³€ê²½
                for (let i = 1; i < path.length; i++) {
                    const nextStatus = path[i];
                    log(`âš™ï¸ ìƒíƒœ ë³€ê²½: ${path[i-1]} â†’ ${nextStatus}`);
                    
                    await updateOrderStatusDirect(orderId, nextStatus);
                    
                    // ì ì‹œ ëŒ€ê¸° (ì„œë²„ ì²˜ë¦¬ ì‹œê°„)
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log(`âœ… ë¹ ë¥¸ ìƒíƒœ ë³€ê²½ ì™„ë£Œ: ${targetStatus}`);
                
            } catch (error) {
                log(`âŒ ë¹ ë¥¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        function getStatusTransitionPath(from, to) {
            // BFSë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœë‹¨ ê²½ë¡œ ì°¾ê¸°
            if (from === to) return [from];
            
            const queue = [[from]];
            const visited = new Set([from]);
            
            while (queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                const nextStates = ORDER_STATUS_FLOW[current] || [];
                
                for (const next of nextStates) {
                    if (next === to) {
                        return [...path, next];
                    }
                    
                    if (!visited.has(next)) {
                        visited.add(next);
                        queue.push([...path, next]);
                    }
                }
            }
            
            return []; // ê²½ë¡œ ì—†ìŒ
        }

        async function updateOrderStatusDirect(orderId, newStatus) {
            const headers = getAuthHeaders();
            headers['Content-Type'] = 'application/json';
            
            const requestData = { status: newStatus };
            
            const response = await fetch(`${BASE_URL}/api/order/orders/${orderId}`, {
                method: 'PATCH',
                headers: headers,
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (${response.status}): ${errorText}`);
            }
            
            return await response.json();
        }

        // --- Onload ---
        window.addEventListener('load', function() {
            log('ğŸ”§ PortOne V2 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            log('ğŸ’¡ ë¨¼ì € í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.');
            updateLoginStatus();
            
            if (typeof window.PortOne !== 'undefined') {
                log('âœ… PortOne V2 SDK ë¡œë“œ ì™„ë£Œ!');
            } else {
                log('âŒ PortOne V2 SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true);
            }
        });
    </script>
</body>
</html>
